<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.flyway_mybatis.mapper.OrderMapper">

    <resultMap id="orderResults" type="com.example.flyway_mybatis.domain.Orders">
        <result column="orders_id" property="orders_id"/>
        <result column="customer_name" property="customer_name"/>
        <result column="total_amount" property="total_amount"/>
        <result column="total_price" property="total_price"/>
        <result column="orders_date" property="orders_date"/>
    </resultMap>

    <insert id="addOrder">
        INSERT INTO orders (orders_id, customer_name, total_amount, total_price)
        VALUES (#{orders_id}, #{customer_name}, #{total_amount}, #{total_price})
    </insert>

    <select id="selectOrderByDate">
        SELECT customer_name, total_price, total_amount
        FROM orders
        WHERE DATE (orders_date) = #{orders_date}
    </select>

    <select id="selectOrderByItemId" parameterType="int">
        SELECT o.total_price, o.total_amount
        FROM orders o
                 JOIN order_item oi ON o.orders_id = oi.orders_id
        WHERE oi.order_item_id = #{order_item_id}
    </select>

    <select id="selectOrderByPrice" parameterType="int">
        SELECT orders_date
        FROM orders
        WHERE total_price > #{total_price}
    </select>

    <!-- 주문 날짜: 해당 orders_id 가 order_item 행 수 >= minItems 인 날짜 반환 -->
    <select id="getOrdersDateMinItems" parameterType="int" resultType="int">
        SELECT o.orders_date
        FROM orders o
        WHERE o.orders_id IN (
            SELECT oi.orders_id
            FROM order_item oi
            GROUP BY oi.orders_id
            HAVING COUNT(*) &gt;= #{minItems}
        )
        ORDER BY o.orders_date
    </select>

</mapper>